<!-- breadcrumb-section -->
<div class="breadcrumb-section breadcrumb-bg">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 offset-lg-2 text-center">
        <div class="breadcrumb-text">
          <h1>Manage Shops</h1>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Shop Button -->
<div class="container">
  <div class="row">
    <div
      class="col-lg-3 d-flex align-items-center mb-4"
      style="margin-top: 32px"
    >
      <button
        class="btn btn-primary"
        style="font-size: 1.1rem; padding: 10px 28px"
        onclick="openAddEShopModal();"
      >
        <i class="fas fa-calendar-plus"></i> Add Shop
      </button>
    </div>
  </div>
</div>

<!-- Main Content -->
<div id="admin-shops-container" class="container mt-100 mb-100"></div>

<!-- Shop Edit Modal -->
<div id="shopModal" class="modal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Shop</h5>
        <button
          type="button"
          class="close"
          data-dismiss="modal"
          aria-label="Close"
        >
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="shopEditForm">
          <div class="form-group">
            <label for="editShopName">Shop Name</label>
            <input
              type="text"
              id="editShopName"
              class="form-control"
              placeholder="Enter shop name"
            />
          </div>
          <div class="form-group">
            <label for="editAddress">Address</label>
            <input
              type="text"
              id="editAddress"
              class="form-control"
              placeholder="Enter address"
            />
          </div>
          <div class="form-group">
            <label for="editCity">City</label>
            <input
              type="text"
              id="editCity"
              class="form-control"
              placeholder="Enter city"
            />
          </div>
          <div class="form-group">
            <label for="editContactNumber">Contact Number</label>
            <input
              type="text"
              id="editContactNumber"
              class="form-control"
              placeholder="Enter contact number"
            />
          </div>
          <div class="form-group">
            <label for="editOpensAt">Opens At</label>
            <input
              type="time"
              id="editOpensAt"
              class="form-control"
              placeholder="Enter opens at"
            />
          </div>
          <div class="form-group">
            <label for="editClosesAt">Closes At</label>
            <input
              type="time"
              id="editClosesAt"
              class="form-control"
              placeholder="Enter closes at"
            />
          </div>
          <div class="form-group">
            <label for="editDescription">Description</label>
            <textarea
              id="editDescription"
              class="form-control"
              placeholder="Enter description"
              rows="3"
            ></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="saveShopChanges">
          Save Changes
        </button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          Close
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Add Shop Modal -->
<div
  class="modal fade"
  id="addShopModal"
  tabindex="-1"
  role="dialog"
  aria-labelledby="addShopModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addShopModalLabel">Add Shop</h5>
        <button
          type="button"
          class="close"
          data-dismiss="modal"
          aria-label="Close"
          onclick="$('#addShopModal').modal('hide')"
        >
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="addShopForm">
          <div class="form-group">
            <label for="addShopName">Shop Name</label>
            <input
              type="text"
              class="form-control"
              id="addShopName"
              placeholder="Enter shop name"
              required
            />
          </div>
          <div class="form-group">
            <label for="addAddress">Address</label>
            <input
              type="text"
              class="form-control"
              id="addAddress"
              placeholder="Enter address"
              required
            />
          </div>
          <div class="form-group">
            <label for="addCity">City</label>
            <input
              type="text"
              class="form-control"
              id="addCity"
              placeholder="Enter city"
              required
            />
          </div>
          <div class="form-group">
            <label for="addContactNumber">Contact Number</label>
            <input
              type="text"
              class="form-control"
              id="addContactNumber"
              placeholder="Enter contact number"
            />
          </div>
          <div class="form-group">
            <label for="addOpensAt">Opens At</label>
            <input type="time" class="form-control" id="addOpensAt" required />
          </div>
          <div class="form-group">
            <label for="addClosesAt">Closes At</label>
            <input type="time" class="form-control" id="addClosesAt" required />
          </div>
          <div class="form-group">
            <label for="addDescription">Description</label>
            <textarea
              class="form-control"
              id="addDescription"
              rows="3"
              placeholder="Enter description"
            ></textarea>
          </div>
          <div class="form-group">
            <label for="addShopImage">Shop Image</label>
            <input
              type="file"
              class="form-control"
              id="addShopImage"
              accept="image/*"
            />
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" onclick="submitAddShop()">
          Add Shop
        </button>
        <button
          type="button"
          class="btn btn-secondary"
          data-dismiss="modal"
          onclick="$('#addShopModal').modal('hide')"
        >
          Close
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  function openAddEShopModal() {
    $("#addShopModal").modal("show");
  }
</script>

<style>
  .user-profile-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  }

  .user-profile-table th,
  .user-profile-table td {
    padding: 15px 20px;
    text-align: left;
    border-bottom: 1px solid #f0f0f0;
  }

  .label-cell {
    width: 30%;
    color: #555;
    font-weight: 600;
    background-color: #f9f9f9;
  }

  .value-cell {
    color: #333;
    font-weight: 500;
  }

  .email-link {
    color: #3498db;
    text-decoration: none;
    transition: color 0.2s;
  }

  .email-link:hover {
    color: #2980b9;
    text-decoration: underline;
  }

  .na-badge {
    color: #999;
    font-style: italic;
  }

  .role-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.85em;
    font-weight: 600;
  }

  .role-badge.admin {
    background-color: #e3f2fd;
    color: #1976d2;
  }

  .role-badge.user {
    background-color: #e8f5e9;
    color: #388e3c;
  }

  .role-badge.moderator {
    background-color: #fff3e0;
    color: #ffa000;
  }

  .actions-row td {
    padding: 15px 0;
    text-align: center;
    background-color: #f9f9f9;
  }

  .action-buttons {
    display: flex;
    justify-content: center;
    gap: 10px;
  }

  .btn {
    padding: 8px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-weight: 500;
  }

  .edit-btn {
    background-color: #4caf50;
    color: white;
  }

  .edit-btn:hover {
    background-color: #3e8e41;
    transform: translateY(-2px);
  }

  .view-btn {
    background-color: #e0e0e0;
    color: #333;
  }

  .view-btn:hover {
    background-color: #bdbdbd;
    color: #111;
    transform: translateY(-2px);
  }

  .delete-btn {
    background-color: #f44336;
    color: white;
  }

  .delete-btn:hover {
    background-color: #d32f2f;
    transform: translateY(-2px);
  }

  .editable {
    position: relative;
    min-width: 200px;
  }

  .edit-mode {
    width: 100%;
  }

  .was-validated .edit-mode:invalid {
    border-color: #dc3545;
  }
</style>

<script>
  AdminManageShops.fetch_all_shops();
  document
    .getElementById("saveShopChanges")
    .addEventListener("click", function () {
      const shopId = document.getElementById("shopModal").dataset.shopId;

      const updatedShop = {
        name: document.getElementById("editShopName").value,
        address: document.getElementById("editAddress").value,
        city: document.getElementById("editCity").value,
        contact_number: document.getElementById("editContactNumber").value,
        opens_at: document.getElementById("editOpensAt").value,
        closes_at: document.getElementById("editClosesAt").value,
        description: document.getElementById("editDescription").value,
      };

      RestClient.put(`admin/shops/${shopId}`, updatedShop, function (response) {
        $("#shopModal").modal("hide");
        AdminManageShops.fetch_all_shops();
      });
    });
</script>

<script>
  document.getElementById("addShopForm").onsubmit = function (e) {
    e.preventDefault();

    // Create FormData object for the file upload
    const formData = new FormData();

    // Add the image file
    const imageFile = document.getElementById("addShopImage").files[0];
    if (!imageFile) {
      toastr.error("Please select an image file");
      return;
    }

    formData.append("shopImage", imageFile);

    // First upload the image file
    fetch("/se-2025/backend/api/upload/shop-image/", {
      method: "POST",
      body: formData,
    })
      .then((response) => {
        if (!response.ok) throw new Error("Failed to upload image");
        return response.json();
      })
      .then((fileData) => {
        // Now create the shop with the image filename
        const shopData = {
          name: document.getElementById("addShopName").value,
          address: document.getElementById("addAddress").value,
          city: document.getElementById("addCity").value,
          contact_number: document.getElementById("addContactNumber").value,
          opens_at: document.getElementById("addOpensAt").value,
          closes_at: document.getElementById("addClosesAt").value,
          description: document.getElementById("addDescription").value,
          image_url: "assets/img/" + fileData.filename,
        };

        // Create the shop with the image filename
        RestClient.post("admin/shops", shopData, function () {
          $("#addShopModal").modal("hide");
          toastr.success("Shop added successfully");
          AdminManageShops.fetch_all_shops();
          document.getElementById("addShopForm").reset();
        });
      })
      .catch((err) => {
        console.error(err);
        toastr.error("Failed to add shop: " + (err.message || "Unknown error"));
      });
  };
</script>
